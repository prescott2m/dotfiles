#!/usr/bin/env bash
set -uo pipefail

if [ "$#" -eq 0 ]; then
  echo "usage: notify_on_exit <command> [args...]" >&2
  exit 1
fi

: "${DISCORD_WEBHOOK_URL:?DISCORD_WEBHOOK_URL not set}"

start_ts=$(date +%s)
cmd=("$@")

"${cmd[@]}"
status=$?

end_ts=$(date +%s)
elapsed=$((end_ts - start_ts))

format_duration() {
  local s=$1
  printf "%dm%02ds" $((s/60)) $((s%60))
}

duration=$(format_duration "$elapsed")
cmd_name=$(printf '%q ' "${cmd[@]}")
cmd_name=${cmd_name% }

jq -n \
  --arg content "\`$cmd_name\` returned $status (${duration})" \
  '{content: $content}' |
curl -sS -X POST \
  -H "Content-Type: application/json" \
  -d @- \
  "$DISCORD_WEBHOOK_URL" >/dev/null

exit "$status"

